<style>
  :host ::ng-deep .p-dialog {
    background: white !important;
    border-radius: 1rem !important;
    box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25) !important;
    border: none !important;
  }
  :host ::ng-deep .p-dialog-mask {
    background-color: rgba(0, 0, 0, 0.4) !important;
    backdrop-filter: blur(4px);
  }
  :host ::ng-deep .p-dialog-header {
    border-top-right-radius: 1rem !important;
    border-top-left-radius: 1rem !important;
    padding: 1.5rem !important;
  }
</style>

<div class="max-w-7xl mx-auto p-6 space-y-6 bg-gray-50 min-h-screen font-sans text-gray-800">

  <p-toast></p-toast>

  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 px-8 py-6">
    <div class="flex flex-col md:flex-row items-center justify-between gap-6">

      <div>
        <h1 class="text-2xl font-extrabold text-gray-900 flex items-center gap-3">
          <span class="bg-blue-600 text-white p-2 rounded-lg">
            <i class="pi pi-box"></i>
          </span>
          Espace Partagé B2B
        </h1>
        <div class="flex items-center gap-2 mt-2 text-sm text-gray-500" *ngIf="currentFolder">
          <i class="pi pi-home cursor-pointer hover:text-blue-600" (click)="loadRoot()"></i>
          <i class="pi pi-angle-right text-xs"></i>
          <span class="font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">{{ currentFolder.name }}</span>
        </div>
      </div>

      <div class="flex items-center gap-3 w-full md:w-auto">
        <button
          (click)="showNewFolder = true"
          class="flex-1 md:flex-none flex items-center justify-center gap-2 px-5 py-2.5 bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 rounded-xl font-semibold transition-all shadow-sm active:scale-95">
          <i class="pi pi-folder-plus text-blue-600"></i>
          <span>Nouveau dossier</span>
        </button>

        <input
          type="file"
          #fileInput
          class="hidden"
          (change)="onFileSelect($event); upload()">

        <button
          (click)="fileInput.click()"
          class="flex-1 md:flex-none flex items-center justify-center gap-2 px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-xl font-semibold transition-all shadow-md active:scale-95">
          <i class="pi pi-upload"></i>
          <span>Uploader</span>
        </button>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
      <div class="w-12 h-12 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center">
        <i class="pi pi-folder text-xl"></i>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Dossiers</p>
        <p class="text-2xl font-bold">{{ stats.folders }}</p>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
      <div class="w-12 h-12 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center">
        <i class="pi pi-file text-xl"></i>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Fichiers</p>
        <p class="text-2xl font-bold">{{ stats.files }}</p>
      </div>
    </div>

    <div class="bg-white rounded-2xl shadow-sm p-6 border border-gray-100 flex items-center gap-4 hover:shadow-md transition-shadow">
      <div class="w-12 h-12 bg-purple-50 text-purple-600 rounded-xl flex items-center justify-center">
        <i class="pi pi-database text-xl"></i>
      </div>
      <div>
        <p class="text-sm font-medium text-gray-400 uppercase tracking-wider">Stockage utilisé</p>
        <p class="text-2xl font-bold">{{ formatSize(stats.storage) }}</p>
      </div>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
    <div class="relative w-full sm:w-96">
      <i class="pi pi-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
      <input
        type="text"
        [(ngModel)]="searchQuery"
        (keyup.enter)="doSearch()"
        placeholder="Rechercher un document..."
        class="w-full pl-11 pr-4 py-3 bg-white border border-gray-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none transition-all shadow-sm">
    </div>

    <button
      (click)="refresh()"
      class="flex items-center gap-2 px-4 py-2 text-gray-500 hover:text-blue-600 font-medium transition-colors">
      <i class="pi pi-refresh" [class.pi-spin]="loading"></i>
      Actualiser la vue
    </button>
  </div>

  <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">

    <div *ngIf="loading" class="flex flex-col items-center justify-center py-20 bg-white/80">
      <i class="pi pi-spin pi-spinner text-4xl text-blue-600"></i>
      <p class="mt-4 text-gray-500 font-medium">Chargement des fichiers...</p>
    </div>

    <p-table
      *ngIf="!loading"
      [value]="resources"
      [paginator]="true"
      [rows]="10"
      responsiveLayout="scroll"
      styleClass="p-datatable-borderless">

      <ng-template pTemplate="header">
        <tr class="bg-gray-50/50 border-b border-gray-100">
          <th class="py-4 px-6 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Nom</th>
          <th class="py-4 px-6 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Type</th>
          <th class="py-4 px-6 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Taille</th>
          <th class="py-4 px-6 text-left text-xs font-bold text-gray-400 uppercase tracking-widest">Date</th>
          <th class="py-4 px-6 text-right text-xs font-bold text-gray-400 uppercase tracking-widest">Actions</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-r>
        <tr class="hover:bg-blue-50/40 transition-colors group">
          <td class="py-4 px-6 cursor-pointer" (dblclick)="r.type === 'FOLDER' && loadFolder(r)">
            <div class="flex items-center gap-3">
              <i class="pi text-xl shadow-sm"
                 [ngClass]="r.type === 'FOLDER' ? 'pi-folder text-amber-400' : getFileIcon(r.name)"></i>
              <span class="font-semibold text-gray-700 group-hover:text-blue-700 transition-colors">{{ r.name }}</span>
            </div>
          </td>
          <td class="py-4 px-6">
            <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase border border-gray-100 bg-gray-50 text-gray-500">
              {{ r.type }}
            </span>
          </td>
          <td class="py-4 px-6 text-sm text-gray-500">
            {{ r.type === 'FILE' ? formatSize(r.fileSize!) : '--' }}
          </td>
          <td class="py-4 px-6 text-sm text-gray-500">
            {{ r.createdAt | date:'dd/MM/yyyy' }}
          </td>
          <td class="py-4 px-6 text-right">
            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <!-- Actions pour les DOSSIERS -->
              <button
                *ngIf="r.type === 'FOLDER'"
                (click)="loadFolder(r)"
                class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
                pTooltip="Ouvrir le dossier"
                tooltipPosition="top">
                <i class="pi pi-folder-open"></i>
              </button>

              <!-- Actions pour les FICHIERS -->
              <ng-container *ngIf="r.type === 'FILE'">
                <!-- Bouton Visualiser -->
                <button
                  (click)="viewFile(r)"
                  class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-colors"
                  pTooltip="Visualiser"
                  tooltipPosition="top">
                  <i class="pi pi-eye"></i>
                </button>

                <!-- Bouton Télécharger -->
                <button
                  (click)="downloadFile(r)"
                  class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
                  pTooltip="Télécharger"
                  tooltipPosition="top">
                  <i class="pi pi-download"></i>
                </button>

                <!-- Bouton Partager -->
                <button
                  (click)="shareFile(r)"
                  class="p-2 text-purple-600 hover:bg-purple-100 rounded-lg transition-colors"
                  pTooltip="Partager"
                  tooltipPosition="top">
                  <i class="pi pi-share-alt"></i>
                </button>
              </ng-container>

              <!-- Bouton Supprimer (pour tous) -->
              <button
                (click)="confirmDelete(r)"
                class="p-2 text-red-500 hover:bg-red-50 rounded-lg transition-colors"
                pTooltip="Supprimer"
                tooltipPosition="top">
                <i class="pi pi-trash"></i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="5" class="py-24 text-center">
            <div class="max-w-xs mx-auto flex flex-col items-center">
              <div class="w-20 h-20 bg-gray-50 rounded-full flex items-center justify-center mb-4">
                <i class="pi pi-search text-3xl text-gray-200"></i>
              </div>
              <h3 class="text-gray-900 font-bold italic">Aucun élément trouvé</h3>
              <p class="text-gray-400 text-sm mt-1">Cet emplacement ne contient aucun fichier ou dossier pour le moment.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <p-dialog
    [(visible)]="showNewFolder"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '450px' }">

    <ng-template pTemplate="header">
      <div class="flex flex-col gap-1">
        <h2 class="text-xl font-bold text-gray-900">Nouveau dossier</h2>
        <p class="text-sm font-normal text-gray-500">Créez un espace de rangement pour vos fichiers.</p>
      </div>
    </ng-template>

    <div class="py-4 space-y-6">
      <div class="flex flex-col gap-2">
        <label class="text-sm font-bold text-gray-700 ml-1">Nom du dossier</label>
        <input
          type="text"
          [(ngModel)]="folderName"
          (keyup.enter)="createFolder()"
          placeholder="Ex: Factures Clients 2024"
          class="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition-all">
      </div>

      <div class="flex items-center gap-3 pt-2">
        <button
          (click)="showNewFolder=false"
          class="flex-1 px-4 py-3 text-gray-500 hover:text-gray-700 font-bold transition-colors">
          Annuler
        </button>
        <button
          (click)="createFolder()"
          class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 active:scale-95 transition-all">
          Créer maintenant
        </button>
      </div>
    </div>
  </p-dialog>

</div>
